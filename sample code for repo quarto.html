<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.340">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Sample code repo</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="sample code for repo quarto_files/libs/clipboard/clipboard.min.js"></script>
<script src="sample code for repo quarto_files/libs/quarto-html/quarto.js"></script>
<script src="sample code for repo quarto_files/libs/quarto-html/popper.min.js"></script>
<script src="sample code for repo quarto_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="sample code for repo quarto_files/libs/quarto-html/anchor.min.js"></script>
<link href="sample code for repo quarto_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="sample code for repo quarto_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="sample code for repo quarto_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="sample code for repo quarto_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="sample code for repo quarto_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Sample code repo</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>This page will provide you with sample code and data to run the analyses in the “<em>Studying the impact of COVID-19 on the European Air Transportation Network”</em>. This sample code uses a combination of R and Python. To run the Python code we use the <code>reticulate</code> package.</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'data.table' was built under R version 4.1.3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'tidyverse' was built under R version 4.1.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>-- Attaching packages --------------------------------------- tidyverse 1.3.2 --
v ggplot2 3.4.2     v purrr   1.0.1
v tibble  3.2.1     v dplyr   1.1.1
v tidyr   1.3.0     v stringr 1.5.0
v readr   2.1.3     v forcats 1.0.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'ggplot2' was built under R version 4.1.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'tibble' was built under R version 4.1.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'tidyr' was built under R version 4.1.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'readr' was built under R version 4.1.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'purrr' was built under R version 4.1.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'dplyr' was built under R version 4.1.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'stringr' was built under R version 4.1.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'forcats' was built under R version 4.1.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>-- Conflicts ------------------------------------------ tidyverse_conflicts() --
x dplyr::between()   masks data.table::between()
x dplyr::filter()    masks stats::filter()
x dplyr::first()     masks data.table::first()
x dplyr::lag()       masks stats::lag()
x dplyr::last()      masks data.table::last()
x purrr::transpose() masks data.table::transpose()</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'foreach' was built under R version 4.1.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'foreach'

The following objects are masked from 'package:purrr':

    accumulate, when</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fdm2id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'fdm2id' was built under R version 4.1.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: arules</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'arules' was built under R version 4.1.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Matrix</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'Matrix' was built under R version 4.1.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'Matrix'

The following objects are masked from 'package:tidyr':

    expand, pack, unpack


Attaching package: 'arules'

The following object is masked from 'package:dplyr':

    recode

The following objects are masked from 'package:base':

    abbreviate, write

Loading required package: arulesViz</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'arulesViz' was built under R version 4.1.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: FactoMineR</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'FactoMineR' was built under R version 4.1.3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'fdm2id'

The following objects are masked from 'package:FactoMineR':

    CA, MCA, PCA</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pruatlas)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearth)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'rnaturalearth' was built under R version 4.1.3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Partiallyoverlapping)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load Python packages</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'reticulate' was built under R version 4.1.3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>graphwave <span class="ot">&lt;-</span> <span class="fu">import_from_path</span>(<span class="at">module =</span> <span class="st">"graphwave"</span>,<span class="at">path =</span> <span class="st">"./graphwave/"</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>np <span class="ot">&lt;-</span> <span class="fu">import</span>(<span class="st">"numpy"</span>)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>nx <span class="ot">&lt;-</span> <span class="fu">import</span>(<span class="st">"networkx"</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>pd <span class="ot">&lt;-</span> <span class="fu">import</span>(<span class="st">"pandas"</span>)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>sk <span class="ot">&lt;-</span> <span class="fu">import</span>(<span class="st">"sklearn"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The data consist of origin-destination flight data for flights departing from, or arriving at airports in EUROCONTROL member states of six weeks (i.e, week 26 to 31) in 2019, 2020, 2021 and 2022 is provided. Each flight is classified using the statfor market segment classification (i.e., Low-cost, Mainline, Regional, Business, Non-scheduled, Military, and Other).</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>net2019 <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"sample_2019.csv"</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>net2020 <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"sample_2020.csv"</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>net2021 <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"sample_2021.csv"</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>net2022 <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"sample_2022.csv"</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>weeks <span class="ot">&lt;-</span> net2019<span class="sc">$</span>week<span class="sc">%&gt;%</span><span class="fu">unique</span>()</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>n_weeks <span class="ot">&lt;-</span> weeks<span class="sc">%&gt;%</span><span class="fu">length</span>()</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>extract_airports <span class="ot">&lt;-</span> <span class="cf">function</span>(net) {</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>  airports_to <span class="ot">&lt;-</span> net <span class="sc">%&gt;%</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>      type.destination <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"medium_airport"</span>, <span class="st">"large_airport"</span>) <span class="sc">&amp;</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>        <span class="sc">!</span>to_member_status <span class="sc">==</span> <span class="st">""</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(destination) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">unlist</span>()</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>  airports_from <span class="ot">&lt;-</span> net <span class="sc">%&gt;%</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(type.origin <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"medium_airport"</span>, <span class="st">"large_airport"</span>) <span class="sc">&amp;</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>             <span class="sc">!</span>from_member_status <span class="sc">==</span> <span class="st">""</span>) <span class="sc">%&gt;%</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(origin) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">unlist</span>()</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>  airports <span class="ot">&lt;-</span> <span class="fu">c</span>(airports_from, airports_to) <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(airports)</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>airports19 <span class="ot">&lt;-</span> <span class="fu">extract_airports</span>(net2019)</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>airports20 <span class="ot">&lt;-</span> <span class="fu">extract_airports</span>(net2020)</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>airports21 <span class="ot">&lt;-</span> <span class="fu">extract_airports</span>(net2021)</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>airports22 <span class="ot">&lt;-</span> <span class="fu">extract_airports</span>(net2022)</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(net2019)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   origin destination week market_segment type.origin type.destination
1:   AFIL        EDDK   28          Other                large_airport
2:   AFIL        EDDV   30          Other                large_airport
3:   AFIL        EDLE   28          Other                small_airport
4:   AFIL        EDTD   29       Business               medium_airport
5:   AFIL        EGXW   29       Military               medium_airport
6:   AFIL        EGXW   30       Military               medium_airport
   from_member_status to_member_status weight
1:                                   M      1
2:                                   M      1
3:                                   M      1
4:                                   M      1
5:                                   M      1
6:                                   M      1</code></pre>
</div>
</div>
<p>Before running the analysis we remove entries containing airports with code AFIL and ZZZZ, as these codes do not relate to actual airports, but are unique identifiers of flight plans that are received in-flight, and unidentified origins. Leaving these connections in the network can result in artifical connections between otherwise unconnected regions (i.e., two airports sharing the same neighbor ZZZ or AFIL). Additionally, as we are interested in connectivity between airports, we remove self loops (i.e., flights originating and arriving at the same airport).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>preprocess_network <span class="ot">&lt;-</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(net,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>           <span class="at">remove_self_loops =</span> <span class="cn">TRUE</span>,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>           <span class="at">remove_AFIL_ZZZZ =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (remove_self_loops <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>      net <span class="ot">&lt;-</span> net <span class="sc">%&gt;%</span> <span class="fu">filter</span>(origin <span class="sc">!=</span> destination)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (remove_AFIL_ZZZZ <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>      net <span class="ot">&lt;-</span> net <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>origin <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"AFIL"</span>, <span class="st">"ZZZZ"</span>) <span class="sc">&amp;</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>                              <span class="sc">!</span>destination <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"AFIL"</span>, <span class="st">"ZZZZ"</span>))</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(net)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>net2019 <span class="ot">&lt;-</span> <span class="fu">preprocess_network</span>(net2019)</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>net2020 <span class="ot">&lt;-</span> <span class="fu">preprocess_network</span>(net2020)</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>net2021 <span class="ot">&lt;-</span> <span class="fu">preprocess_network</span>(net2021)</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>net2022 <span class="ot">&lt;-</span> <span class="fu">preprocess_network</span>(net2022)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="step-1-graphwave-analysis" class="level3">
<h3 class="anchored" data-anchor-id="step-1-graphwave-analysis">Step 1: GraphWave analysis</h3>
<p>The first step in the analysis consists of running the GraphWave algorithm on our networks. The GraphWave algorithm takes as input a graph object that we create using networkx.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># label: create-networks</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="co"># include: true</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>create_nx_graph <span class="ot">&lt;-</span> <span class="cf">function</span>(net, <span class="at">weighted =</span> <span class="cn">TRUE</span>) {</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  net <span class="ot">&lt;-</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    net <span class="sc">%&gt;%</span> <span class="fu">select</span>(origin, destination, weight) <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">source =</span> origin,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">target =</span> destination)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  net <span class="ot">&lt;-</span> pd<span class="sc">$</span><span class="fu">DataFrame</span>(net)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (weighted <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    g <span class="ot">&lt;-</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>      nx<span class="sc">$</span><span class="fu">from_pandas_edgelist</span>(net,</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>                              <span class="at">edge_attr =</span> <span class="cn">TRUE</span>,</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>                              <span class="at">create_using =</span> nx<span class="sc">$</span>DiGraph)</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    g <span class="ot">&lt;-</span> nx<span class="sc">$</span><span class="fu">from_pandas_edgelist</span>(net[, <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>], <span class="at">create_using =</span> nx<span class="sc">$</span>DiGraph)</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(g)</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>nodes_to_string <span class="ot">&lt;-</span> <span class="cf">function</span>(nodes) {</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>  nodes <span class="ot">&lt;-</span> <span class="fu">toString</span>(nodes)</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>  nodes <span class="ot">&lt;-</span> <span class="fu">substr</span>(nodes, <span class="dv">3</span>, <span class="fu">nchar</span>(nodes) <span class="sc">-</span> <span class="dv">2</span>)</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>  nodes <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_remove_all</span>(nodes, <span class="st">"'"</span>)</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>  nodes <span class="ot">&lt;-</span> stringr<span class="sc">::</span><span class="fu">str_split</span>(nodes, <span class="st">", "</span>)[[<span class="dv">1</span>]]</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(nodes)</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Starting with 2019, we create an embedding of each week in our dataset. As 2019 will be our reference for the study, we set <code>taus</code> option of the GraphWave algoritm to “auto”. This allows the algorithm to find the optimal signal to propagate through the network.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>embeddings_2019 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>taus_2019 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (wk <span class="cf">in</span> weeks) {</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(paste("Processing week", wk))</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  el <span class="ot">&lt;-</span> <span class="fu">create_nx_graph</span>(net2019 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(week <span class="sc">==</span> wk))</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  emb <span class="ot">&lt;-</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    graphwave<span class="sc">$</span><span class="fu">graphwave_alg</span>(el,</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="at">length.out =</span> <span class="dv">25</span>),</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>                            <span class="at">taus =</span> <span class="st">"auto"</span>,</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>                            <span class="at">verbose =</span> F)</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>  embedding <span class="ot">&lt;-</span> emb[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>  embedding<span class="sc">$</span>name <span class="ot">&lt;-</span> <span class="fu">nodes_to_string</span>(el<span class="sc">$</span>nodes)</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>  embeddings_2019[[wk]] <span class="ot">&lt;-</span> embedding</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>  taus_2019[[wk]] <span class="ot">&lt;-</span> emb[[<span class="dv">3</span>]]</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For the networks in the weeks in 2020-2022, we now use the optimal tau values from the baseline network. This way we can compare our target weeks under the same conditions as our reference weeks.</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>embeddings_2020 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (wk <span class="cf">in</span> weeks) {</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(paste("Processing week", wk))</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  el <span class="ot">&lt;-</span> <span class="fu">create_nx_graph</span>(net2020 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(week <span class="sc">==</span> wk))</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  emb <span class="ot">&lt;-</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    graphwave<span class="sc">$</span><span class="fu">graphwave_alg</span>(el,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="at">length.out =</span> <span class="dv">25</span>),</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">taus =</span> taus_2019[[wk]],</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>                            <span class="at">verbose =</span> F)</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  embedding <span class="ot">&lt;-</span> emb[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  embedding<span class="sc">$</span>name <span class="ot">&lt;-</span> <span class="fu">nodes_to_string</span>(el<span class="sc">$</span>nodes)</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>  embeddings_2020[[wk]] <span class="ot">&lt;-</span> embedding</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>embeddings_2021 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (wk <span class="cf">in</span> weeks) {</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(paste("Processing week", wk))</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>  el <span class="ot">&lt;-</span> <span class="fu">create_nx_graph</span>(net2021 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(week <span class="sc">==</span> wk))</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>  emb <span class="ot">&lt;-</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>    graphwave<span class="sc">$</span><span class="fu">graphwave_alg</span>(el,</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="at">length.out =</span> <span class="dv">25</span>),</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>                            <span class="at">taus =</span> taus_2019[[wk]],</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>                            <span class="at">verbose =</span> F)</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>  embedding <span class="ot">&lt;-</span> emb[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>  embedding<span class="sc">$</span>name <span class="ot">&lt;-</span> <span class="fu">nodes_to_string</span>(el<span class="sc">$</span>nodes)</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>  embeddings_2021[[wk]] <span class="ot">&lt;-</span> embedding</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>embeddings_2022 <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (wk <span class="cf">in</span> weeks) {</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(paste("Processing week", wk))</span></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>  el <span class="ot">&lt;-</span> <span class="fu">create_nx_graph</span>(net2022 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(week <span class="sc">==</span> wk))</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>  emb <span class="ot">&lt;-</span></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>    graphwave<span class="sc">$</span><span class="fu">graphwave_alg</span>(el,</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="at">length.out =</span> <span class="dv">25</span>),</span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>                            <span class="at">taus =</span> taus_2019[[wk]],</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>                            <span class="at">verbose =</span> F)</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>  embedding <span class="ot">&lt;-</span> emb[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>  embedding<span class="sc">$</span>name <span class="ot">&lt;-</span> <span class="fu">nodes_to_string</span>(el<span class="sc">$</span>nodes)</span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>  embeddings_2022[[wk]] <span class="ot">&lt;-</span> embedding</span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-2-k-means-clustering" class="level3">
<h3 class="anchored" data-anchor-id="step-2-k-means-clustering">Step 2: K-means clustering</h3>
<p>To find the structural roles in the network, we first run a k-means clustering algorithm to find clusters of airports that have a similar heat propagation signature. We make use of the Calinski-Harabasz index to evaluate the optimal number of clusters.</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>create_scree_plot <span class="ot">&lt;-</span> <span class="cf">function</span>(data, k_centers) {</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  wcss <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  ch_index <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># fit the k-means model for different values of the number of clusters</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>k_centers) {</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    kmeans_fit <span class="ot">&lt;-</span> <span class="fu">kmeans</span>(data, <span class="at">centers =</span> i, <span class="at">iter.max =</span> <span class="dv">50</span>)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    wcss[[i]] <span class="ot">&lt;-</span> kmeans_fit<span class="sc">$</span>tot.withinss</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>      ch_index[[i]] <span class="ot">&lt;-</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>        sk<span class="sc">$</span>metrics<span class="sc">$</span><span class="fu">calinski_harabasz_score</span>(data, kmeans_fit<span class="sc">$</span>cluster)</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># plot the WCSS values against the number of clusters</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span><span class="sc">:</span>k_centers,</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlist</span>(wcss),</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">"b"</span>,</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">main =</span> <span class="st">"Elbow Method"</span>,</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">xlab =</span> <span class="st">"Number of clusters"</span>,</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">ylab =</span> <span class="st">"Within-cluster sum of squares"</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">wcss =</span> <span class="fu">unlist</span>(wcss),</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">ch_index =</span> <span class="fu">unlist</span>(ch_index)</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>clustering_index <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> weeks) {</span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>  clustering_index[[i]] <span class="ot">&lt;-</span></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">create_scree_plot</span>(embeddings_2019[[i]][, <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>], <span class="at">k_centers =</span> <span class="dv">20</span>)</span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="sample-code-for-repo-quarto_files/figure-html/ch-index-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="sample-code-for-repo-quarto_files/figure-html/ch-index-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="sample-code-for-repo-quarto_files/figure-html/ch-index-3.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="sample-code-for-repo-quarto_files/figure-html/ch-index-4.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="sample-code-for-repo-quarto_files/figure-html/ch-index-5.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output-display">
<p><img src="sample-code-for-repo-quarto_files/figure-html/ch-index-6.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>clust <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, clustering_index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-warnigns="false">
<div class="cell-output-display">
<p><img src="sample-code-for-repo-quarto_files/figure-html/ch-plot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Even these 6 consecutive weeks show variability in the optimal number of clusters. To find the optimal number of clusters for this timeperiod we rank each clustering solution based on its ch index score and average each rank score across the weeks.</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">ch_index =</span> <span class="fu">do.call</span>(c, clust[, <span class="dv">2</span>]),</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_clust =</span> <span class="fu">rep</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">20</span>, n_weeks),</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">week =</span> <span class="fu">foreach</span>(<span class="at">i =</span> weeks, <span class="at">.combine =</span> c) <span class="sc">%do%</span> {</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rep</span>(i, <span class="dv">19</span>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(week) <span class="sc">%&gt;%</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">reframe</span>(<span class="at">rank =</span> <span class="fu">rank</span>(ch_index),</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>          <span class="at">ch_index =</span> ch_index,</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">n_clust =</span> n_clust) <span class="sc">%&gt;%</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(n_clust) <span class="sc">%&gt;%</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">rank =</span> <span class="fu">mean</span>(rank)) <span class="sc">%&gt;%</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(rank))<span class="sc">%&gt;%</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 x 2
  n_clust  rank
    &lt;int&gt; &lt;dbl&gt;
1       6  17  
2       7  17  
3       8  16  
4       5  14.2
5      12  14.2</code></pre>
</div>
</div>
<p>Next we use the optimal number of clusters we create a model for each week that classifies each airport in the network based on its heat propagation signature. One issue with using multiple baseline models (i.e., one for each week), is that k-means predictions have no inherent sense of ordinality, meaning that for instance the largest airports do not always end it in the cluster with the largest value. To circumvent this problem, we use a heuristic using PCA to reduce our signals to 2 dimensions and fix the axes as such that the largest airport is in the (“LFTM”) is in the top right corner, as such that increase in pca dimension 1 relates to airports with increasing levels of connectivity.</p>
<p>Clusters are then renamed based on their occurrence on the pca dimension 1, as such that the cluster containing the least connective airports get assigned 1, and the cluster with the most connective airports are assigned 6. This approach works for six clusters, as the change in connectivity is nicely captured by PCA dimension 1. Note that with overlapping clusters, a different approach should be tried.</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>generate_clusters <span class="ot">&lt;-</span> <span class="cf">function</span>(data, kmeans_model) {</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  data<span class="sc">$</span>cluster <span class="ot">&lt;-</span> <span class="fu">predict</span>(kmeans_model, data[, <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>])</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  pca1 <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(data[, <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>])<span class="sc">$</span>x[, <span class="dv">1</span>]</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  pca2 <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(data[, <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>])<span class="sc">$</span>x[, <span class="dv">2</span>]</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (pca1[data<span class="sc">$</span>name <span class="sc">==</span> <span class="st">"LTFM"</span>] <span class="sc">&lt;</span> <span class="dv">0</span>) {</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    pca1 <span class="ot">&lt;-</span> <span class="sc">-</span>pca1</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (pca2[data<span class="sc">$</span>name <span class="sc">==</span> <span class="st">"LTFM"</span>] <span class="sc">&lt;</span> <span class="dv">0</span>) {</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    pca2 <span class="ot">&lt;-</span> <span class="sc">-</span>pca2</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  clustering <span class="ot">&lt;-</span> data[, <span class="dv">101</span><span class="sc">:</span><span class="dv">102</span>] <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(pca1, pca2, data<span class="sc">$</span>cluster) <span class="sc">%&gt;%</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>      <span class="fu">arrange</span>(pca1) <span class="sc">%&gt;%</span> <span class="fu">select</span>(data.cluster) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">clust =</span> <span class="fu">unique</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>())) <span class="sc">%&gt;%</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">cluster =</span> data.cluster)</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(name, clust)</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(clustering)</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>clust6_kmeans_models <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> weeks) {</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  clust6_kmeans_models[[i]] <span class="ot">&lt;-</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">kmeans</span>(embeddings_2019[[i]][, <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>], <span class="dv">6</span>)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>net2019_clust_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>net2020_clust_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>net2021_clust_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>net2022_clust_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> weeks) {</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>  net2019_clust <span class="ot">&lt;-</span></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_clusters</span>(embeddings_2019[[i]], clust6_kmeans_models[[i]])</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>  net2020_clust <span class="ot">&lt;-</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_clusters</span>(embeddings_2020[[i]], clust6_kmeans_models[[i]])</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>  net2021_clust <span class="ot">&lt;-</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_clusters</span>(embeddings_2021[[i]], clust6_kmeans_models[[i]])</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>  net2022_clust <span class="ot">&lt;-</span></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">generate_clusters</span>(embeddings_2022[[i]], clust6_kmeans_models[[i]])</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>  net2019_clust<span class="sc">$</span>week <span class="ot">&lt;-</span> i</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>  net2020_clust<span class="sc">$</span>week <span class="ot">&lt;-</span> i</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>  net2021_clust<span class="sc">$</span>week <span class="ot">&lt;-</span> i</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>  net2022_clust<span class="sc">$</span>week <span class="ot">&lt;-</span> i</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>  net2019_clust<span class="sc">$</span>year <span class="ot">&lt;-</span> <span class="dv">2019</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>  net2020_clust<span class="sc">$</span>year <span class="ot">&lt;-</span> <span class="dv">2020</span></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>  net2021_clust<span class="sc">$</span>year <span class="ot">&lt;-</span> <span class="dv">2021</span></span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>  net2022_clust<span class="sc">$</span>year <span class="ot">&lt;-</span> <span class="dv">2022</span></span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>  net2019_clust_list[[i]] <span class="ot">&lt;-</span></span>
<span id="cb45-33"><a href="#cb45-33" aria-hidden="true" tabindex="-1"></a>    net2019_clust</span>
<span id="cb45-34"><a href="#cb45-34" aria-hidden="true" tabindex="-1"></a>  net2020_clust_list[[i]] <span class="ot">&lt;-</span></span>
<span id="cb45-35"><a href="#cb45-35" aria-hidden="true" tabindex="-1"></a>    net2020_clust</span>
<span id="cb45-36"><a href="#cb45-36" aria-hidden="true" tabindex="-1"></a>  net2021_clust_list[[i]] <span class="ot">&lt;-</span></span>
<span id="cb45-37"><a href="#cb45-37" aria-hidden="true" tabindex="-1"></a>    net2021_clust</span>
<span id="cb45-38"><a href="#cb45-38" aria-hidden="true" tabindex="-1"></a>  net2022_clust_list[[i]] <span class="ot">&lt;-</span></span>
<span id="cb45-39"><a href="#cb45-39" aria-hidden="true" tabindex="-1"></a>    net2022_clust</span>
<span id="cb45-40"><a href="#cb45-40" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`
Joining with `by = join_by(cluster)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>net2019_clust <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, net2019_clust_list)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>net2020_clust <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, net2020_clust_list)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>net2021_clust <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, net2021_clust_list)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>net2022_clust <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, net2022_clust_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="step-3-visualize-heat-propagation" class="level3">
<h3 class="anchored" data-anchor-id="step-3-visualize-heat-propagation">Step 3: Visualize heat propagation</h3>
<p>To visualize the heat propagation for a given airport in a given week, we need to access the heat signatures that are stored in the graphwave embedding. Each tau given to the algorithm, or two if the default setting is used, has a heat signature related to it.</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>airports <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"airports_20221025.csv"</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>node.coords <span class="ot">&lt;-</span> airports[, <span class="fu">c</span>(<span class="st">"ident"</span>, <span class="st">"latitude_deg"</span>, <span class="st">"longitude_deg"</span>, <span class="st">"type"</span>)]</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>net <span class="ot">&lt;-</span> net2019<span class="sc">%&gt;%</span><span class="fu">filter</span>(week <span class="sc">==</span> weeks[<span class="dv">1</span>])</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>el <span class="ot">&lt;-</span> <span class="fu">create_nx_graph</span>(net)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>emb <span class="ot">&lt;-</span> graphwave<span class="sc">$</span><span class="fu">graphwave_alg</span>(el,<span class="fu">seq</span>(<span class="dv">0</span>,<span class="dv">100</span>,<span class="at">length.out =</span> <span class="dv">25</span>),<span class="at">taus =</span> <span class="st">"auto"</span>,<span class="at">verbose =</span> <span class="cn">TRUE</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>embedding <span class="ot">&lt;-</span> emb[[<span class="dv">1</span>]]<span class="sc">%&gt;%</span><span class="fu">as.data.frame</span>()</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>embedding<span class="sc">$</span>name <span class="ot">&lt;-</span> <span class="fu">nodes_to_string</span>(el<span class="sc">$</span>nodes)</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>embedding <span class="ot">&lt;-</span> embedding<span class="sc">%&gt;%</span><span class="fu">filter</span>(name <span class="sc">%in%</span> airports19)</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>heat_df_lower <span class="ot">&lt;-</span> pd<span class="sc">$</span><span class="fu">DataFrame</span>(emb[[<span class="dv">2</span>]][[<span class="dv">1</span>]]<span class="sc">$</span><span class="fu">toarray</span>())</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>heat_df_upper <span class="ot">&lt;-</span> pd<span class="sc">$</span><span class="fu">DataFrame</span>(emb[[<span class="dv">2</span>]][[<span class="dv">2</span>]]<span class="sc">$</span><span class="fu">toarray</span>())</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>heat_df <span class="ot">&lt;-</span> (heat_df_lower <span class="sc">+</span> heat_df_upper)<span class="sc">/</span><span class="dv">2</span> </span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>heat_df <span class="ot">&lt;-</span> heat_df_upper </span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>heat_df<span class="sc">$</span>name <span class="ot">&lt;-</span> <span class="fu">nodes_to_string</span>(el<span class="sc">$</span>nodes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Each row in the data.frame represent the amount of energy that is sent from a given airport to each other airport in the network (which are represented by the columns). The following code allows us to create a plot that shows the heat that is being propagated from a focal airport.</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>heat_by_airport <span class="ot">&lt;-</span> heat_df<span class="sc">%&gt;%</span><span class="fu">filter</span>(name <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"LIBC"</span>,<span class="st">"LGSM"</span>,<span class="st">'EGTE'</span>,<span class="st">"LIMF"</span>,<span class="st">"EGBB"</span>,<span class="st">"EGKK"</span>))<span class="sc">%&gt;%</span>reshape2<span class="sc">::</span><span class="fu">melt</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using name as id variables</code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>heat_by_airport<span class="sc">$</span>variable <span class="ot">&lt;-</span> heat_by_airport<span class="sc">$</span>variable<span class="sc">%&gt;%</span><span class="fu">as.character</span>()<span class="sc">%&gt;%</span><span class="fu">as.numeric</span>()</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>heat_by_airport <span class="ot">&lt;-</span> heat_by_airport<span class="sc">%&gt;%</span><span class="fu">left_join</span>(<span class="fu">data.frame</span>(<span class="at">variable =</span> <span class="dv">0</span><span class="sc">:</span>(<span class="fu">nrow</span>(heat_df)<span class="sc">-</span><span class="dv">1</span>),</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>                                                          <span class="at">target =</span> heat_df<span class="sc">$</span>name))<span class="sc">%&gt;%</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">focal_airport =</span> name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(variable)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>plot_heat <span class="ot">&lt;-</span> <span class="cf">function</span>(df,<span class="at">what =</span> <span class="st">"EU"</span>){</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  world <span class="ot">&lt;-</span> <span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="st">"small"</span>, <span class="at">returnclass =</span> <span class="st">"sf"</span>)</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">=</span> <span class="fu">left_join</span>(node.coords,df,<span class="at">by=</span><span class="fu">c</span>(<span class="st">"ident"</span> <span class="ot">=</span> <span class="st">"target"</span>))</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(world) <span class="sc">+</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">fill =</span> <span class="st">"white"</span>) <span class="sc">+</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> latitude_deg, <span class="at">x =</span> longitude_deg,<span class="at">col=</span>value),</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>             data<span class="sc">%&gt;%</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>               <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value) <span class="sc">&amp;</span> value <span class="sc">&lt;=</span> .<span class="dv">35</span> <span class="sc">&amp;</span> value <span class="sc">&gt;</span> .<span class="dv">05</span>),</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>             <span class="at">size=</span><span class="dv">1</span>,<span class="at">alpha =</span> .<span class="dv">8</span>) <span class="sc">+</span> </span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> latitude_deg, <span class="at">x =</span> longitude_deg,<span class="at">col=</span>value),</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>             data<span class="sc">%&gt;%</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>               <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value) <span class="sc">&amp;</span> value <span class="sc">&lt;=</span> .<span class="dv">45</span> <span class="sc">&amp;</span> value <span class="sc">&gt;</span> .<span class="dv">35</span>),</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>             <span class="at">size=</span><span class="dv">1</span>,<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> latitude_deg, <span class="at">x =</span> longitude_deg,<span class="at">col=</span>value),</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>             data<span class="sc">%&gt;%</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>               <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value) <span class="sc">&amp;</span> value <span class="sc">&lt;=</span> .<span class="dv">65</span> <span class="sc">&amp;</span> value <span class="sc">&gt;</span> .<span class="dv">45</span>),</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>             <span class="at">size=</span><span class="dv">1</span>,<span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> latitude_deg, <span class="at">x =</span> longitude_deg,<span class="at">col=</span>value),</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>             data<span class="sc">%&gt;%</span></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>               <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value) <span class="sc">&amp;</span> value <span class="sc">&gt;</span> .<span class="dv">65</span>),</span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>             <span class="at">size=</span><span class="dv">1</span>) <span class="sc">+</span> <span class="fu">scale_color_gradient2</span>(<span class="at">high=</span><span class="st">"red"</span>,<span class="at">mid=</span><span class="st">"yellow"</span>,<span class="at">low =</span> <span class="st">"black"</span>,<span class="at">midpoint =</span> .<span class="dv">5</span>)<span class="sc">+</span> </span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>focal_airport)<span class="sc">+</span><span class="fu">theme_minimal</span>()<span class="sc">+</span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">"heat"</span>)<span class="sc">+</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"grey"</span>),<span class="at">legend.position =</span> <span class="st">"top"</span>)</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(what <span class="sc">==</span> <span class="st">"EU"</span>){</span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>    p <span class="sc">+</span> <span class="fu">coord_sf</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">25</span>,<span class="dv">50</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">35</span>,<span class="dv">70</span>), <span class="at">expand =</span> <span class="cn">FALSE</span>)</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>    p</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Specifically, the code normalizes the energy to show which airports have are the most strongly connected (i.e., receive the most energy).</p>
<div class="cell" data-echoes="false" data-warnings="false">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>heat_EGKK <span class="ot">&lt;-</span> heat_by_airport<span class="sc">%&gt;%</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(focal_airport <span class="sc">==</span> <span class="st">"EGKK"</span>)<span class="sc">%&gt;%</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value =</span> (value <span class="sc">-</span> <span class="fu">min</span>(value))<span class="sc">/</span>(<span class="fu">max</span>(value) <span class="sc">-</span> <span class="fu">min</span>(value)))<span class="sc">%&gt;%</span><span class="fu">arrange</span>(<span class="fu">desc</span>(value))</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_heat</span>(heat_EGKK,<span class="at">what =</span> <span class="st">"EU"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="sample-code-for-repo-quarto_files/figure-html/single-airport-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_heat</span>(heat_EGKK,<span class="at">what =</span> <span class="st">"world"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="sample-code-for-repo-quarto_files/figure-html/single-airport-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Note that when we include multiple airports, the normalization now compares the amount heat propagated between the airports.</p>
<div class="cell" data-echoes="false" data-warnings="false">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>heat_norm <span class="ot">&lt;-</span> heat_by_airport<span class="sc">%&gt;%</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">value =</span> (value <span class="sc">-</span> <span class="fu">min</span>(value))<span class="sc">/</span>(<span class="fu">max</span>(value) <span class="sc">-</span> <span class="fu">min</span>(value)))<span class="sc">%&gt;%</span><span class="fu">arrange</span>(<span class="fu">desc</span>(value))</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_heat</span>(heat_norm,<span class="at">what =</span> <span class="st">"EU"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="sample-code-for-repo-quarto_files/figure-html/multiple-airports-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_heat</span>(heat_norm,<span class="at">what =</span> <span class="st">"world"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="sample-code-for-repo-quarto_files/figure-html/multiple-airports-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="step-4-finding-cluster-differences" class="level3">
<h3 class="anchored" data-anchor-id="step-4-finding-cluster-differences">Step 4: Finding cluster differences</h3>
<p>Next, we can use our classified airports to find changes in cluster membership between two years. For this we use a function that calculates the difference of the average cluster membership for the baseline year and the target year.</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>find_clust_diff <span class="ot">&lt;-</span> <span class="cf">function</span>(net1, net2, what, <span class="at">type =</span> <span class="st">"sum"</span>) {</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>  net1_full <span class="ot">&lt;-</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">name =</span> <span class="fu">sort</span>(<span class="fu">rep</span>(net1<span class="sc">$</span>name <span class="sc">%&gt;%</span> <span class="fu">unique</span>(), n_weeks)),</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">week =</span> <span class="fu">rep</span>(weeks, net1<span class="sc">$</span>name <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>()))</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>  net2_full <span class="ot">&lt;-</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(<span class="at">name =</span> <span class="fu">sort</span>(<span class="fu">rep</span>(net2<span class="sc">$</span>name <span class="sc">%&gt;%</span> <span class="fu">unique</span>(), n_weeks)),</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>               <span class="at">week =</span> <span class="fu">rep</span>(weeks, net2<span class="sc">$</span>name <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>()))</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>  tab_base <span class="ot">&lt;-</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>    net1_full <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(net1[, <span class="fu">c</span>(<span class="st">"name"</span>, <span class="st">"clust"</span>, <span class="st">"week"</span>)]) <span class="sc">%&gt;%</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">replace</span>(<span class="fu">is.na</span>(.), <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(name, clust) <span class="sc">%&gt;%</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">table</span>()</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>  tab_new <span class="ot">&lt;-</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>    net2_full <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(net2[, <span class="fu">c</span>(<span class="st">"name"</span>, <span class="st">"clust"</span>, <span class="st">"week"</span>)]) <span class="sc">%&gt;%</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">replace</span>(<span class="fu">is.na</span>(.), <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(name, clust) <span class="sc">%&gt;%</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">table</span>()</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (what <span class="sc">==</span> <span class="st">"region"</span>) {</span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> tab_base <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">Freq1 =</span> Freq) <span class="sc">%&gt;%</span></span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">full_join</span>(tab_new <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">Freq2 =</span> Freq)) <span class="sc">%&gt;%</span></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">replace</span>(<span class="fu">is.na</span>(.), <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">clust =</span> <span class="fu">as.numeric</span>(clust) <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>             <span class="at">sum1 =</span> clust <span class="sc">*</span> Freq1,</span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>             <span class="at">sum2 =</span> clust <span class="sc">*</span> Freq2) <span class="sc">%&gt;%</span></span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span></span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">avg_role_base =</span> <span class="fu">sum</span>(sum1) <span class="sc">/</span> n_weeks,</span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>                <span class="at">avg_role_new =</span> <span class="fu">sum</span>(sum2) <span class="sc">/</span> n_weeks) <span class="sc">%&gt;%</span></span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">diff =</span> avg_role_new <span class="sc">-</span> avg_role_base) <span class="sc">%&gt;%</span></span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">region =</span> <span class="fu">substr</span>(name, <span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"absolute"</span>) {</span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>      res <span class="ot">&lt;-</span> res <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(region) <span class="sc">%&gt;%</span></span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">diff =</span> <span class="fu">sum</span>(<span class="fu">abs</span>(diff))) <span class="sc">%&gt;%</span> <span class="co"># Find regions with most class mobility</span></span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a>        <span class="fu">arrange</span>(<span class="fu">desc</span>(diff))</span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"mean"</span>) {</span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a>      res <span class="ot">&lt;-</span> res <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(region) <span class="sc">%&gt;%</span></span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">diff =</span> <span class="fu">mean</span>(diff)) </span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a>        <span class="fu">arrange</span>(<span class="fu">desc</span>(diff))</span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"median"</span>) {</span>
<span id="cb58-41"><a href="#cb58-41" aria-hidden="true" tabindex="-1"></a>      res <span class="ot">&lt;-</span> res <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(region) <span class="sc">%&gt;%</span></span>
<span id="cb58-42"><a href="#cb58-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">diff =</span> <span class="fu">median</span>(diff))</span>
<span id="cb58-43"><a href="#cb58-43" aria-hidden="true" tabindex="-1"></a>        <span class="fu">arrange</span>(<span class="fu">desc</span>(diff))</span>
<span id="cb58-44"><a href="#cb58-44" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (type <span class="sc">==</span> <span class="st">"sum"</span>) {</span>
<span id="cb58-45"><a href="#cb58-45" aria-hidden="true" tabindex="-1"></a>      res <span class="ot">&lt;-</span> res <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(region) <span class="sc">%&gt;%</span></span>
<span id="cb58-46"><a href="#cb58-46" aria-hidden="true" tabindex="-1"></a>        <span class="fu">summarise</span>(<span class="at">diff =</span> <span class="fu">sum</span>(diff)) <span class="sc">%&gt;%</span></span>
<span id="cb58-47"><a href="#cb58-47" aria-hidden="true" tabindex="-1"></a>        <span class="fu">arrange</span>(<span class="fu">desc</span>(diff))</span>
<span id="cb58-48"><a href="#cb58-48" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb58-49"><a href="#cb58-49" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb58-50"><a href="#cb58-50" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (what <span class="sc">==</span> <span class="st">"airport"</span>) {</span>
<span id="cb58-51"><a href="#cb58-51" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> tab_base <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span></span>
<span id="cb58-52"><a href="#cb58-52" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">Freq1 =</span> Freq) <span class="sc">%&gt;%</span></span>
<span id="cb58-53"><a href="#cb58-53" aria-hidden="true" tabindex="-1"></a>      <span class="fu">full_join</span>(tab_new <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">Freq2 =</span> Freq)) <span class="sc">%&gt;%</span></span>
<span id="cb58-54"><a href="#cb58-54" aria-hidden="true" tabindex="-1"></a>      <span class="fu">replace</span>(<span class="fu">is.na</span>(.), <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb58-55"><a href="#cb58-55" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">clust =</span> <span class="fu">as.numeric</span>(clust) <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb58-56"><a href="#cb58-56" aria-hidden="true" tabindex="-1"></a>             <span class="at">sum1 =</span> clust <span class="sc">*</span> Freq1,</span>
<span id="cb58-57"><a href="#cb58-57" aria-hidden="true" tabindex="-1"></a>             <span class="at">sum2 =</span> clust <span class="sc">*</span> Freq2) <span class="sc">%&gt;%</span></span>
<span id="cb58-58"><a href="#cb58-58" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(name) <span class="sc">%&gt;%</span></span>
<span id="cb58-59"><a href="#cb58-59" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">avg_role_base =</span> <span class="fu">sum</span>(sum1) <span class="sc">/</span> n_weeks,</span>
<span id="cb58-60"><a href="#cb58-60" aria-hidden="true" tabindex="-1"></a>                <span class="at">avg_role_new =</span> <span class="fu">sum</span>(sum2) <span class="sc">/</span> n_weeks) <span class="sc">%&gt;%</span></span>
<span id="cb58-61"><a href="#cb58-61" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">diff =</span> avg_role_new <span class="sc">-</span> avg_role_base) <span class="sc">%&gt;%</span></span>
<span id="cb58-62"><a href="#cb58-62" aria-hidden="true" tabindex="-1"></a>      <span class="fu">arrange</span>(<span class="fu">desc</span>(diff))</span>
<span id="cb58-63"><a href="#cb58-63" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb58-64"><a href="#cb58-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(res)</span>
<span id="cb58-65"><a href="#cb58-65" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>airport_diff <span class="ot">&lt;-</span> <span class="fu">find_clust_diff</span>(</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  net2019_clust <span class="sc">%&gt;%</span> <span class="fu">filter</span>(name <span class="sc">%in%</span> airports19),</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  net2022_clust <span class="sc">%&gt;%</span> <span class="fu">filter</span>(name <span class="sc">%in%</span> airports22),</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"airport"</span>,</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"sum"</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(diff)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(name, week)`
Joining with `by = join_by(name, week)`
Joining with `by = join_by(name, clust)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>regional_diff <span class="ot">&lt;-</span> <span class="fu">find_clust_diff</span>(</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  net2019_clust <span class="sc">%&gt;%</span> <span class="fu">filter</span>(name <span class="sc">%in%</span> airports19),</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  net2022_clust <span class="sc">%&gt;%</span> <span class="fu">filter</span>(name <span class="sc">%in%</span> airports22),</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"region"</span>,</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"sum"</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(diff)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(name, week)`
Joining with `by = join_by(name, week)`
Joining with `by = join_by(name, clust)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(airport_diff)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 x 4
  name  avg_role_base avg_role_new  diff
  &lt;fct&gt;         &lt;dbl&gt;        &lt;dbl&gt; &lt;dbl&gt;
1 UKBB            5              0  -5  
2 UKKK            4              0  -4  
3 UKLL            3.5            0  -3.5
4 LIRI            3              0  -3  
5 UKHH            3              0  -3  
6 UKOO            3              0  -3  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(regional_diff)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 x 2
  region    diff
  &lt;chr&gt;    &lt;dbl&gt;
1 UK     -29.8  
2 ES      -3.33 
3 LT      -3.17 
4 LF      -2.17 
5 EF      -1    
6 UG      -0.833</code></pre>
</div>
</div>
<p>We can then use these outputs to compare change in connectivity between two adjacent years. Note that this plot differs from the plot used in our paper, as we are now only focusing on a smaller period of time.</p>
<div class="cell" data-warnings="false">
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(name, week)`
Joining with `by = join_by(name, week)`
Joining with `by = join_by(name, clust)`</code></pre>
</div>
<div class="cell-output-display">
<p><img src="sample-code-for-repo-quarto_files/figure-html/diff-plot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Additionally, we can also use the output to create a regional plot that shows changes in structural for airports in a given region.</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>airports <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"airports_20221025.csv"</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>node.coords <span class="ot">&lt;-</span> airports[, <span class="fu">c</span>(<span class="st">"ident"</span>, <span class="st">"latitude_deg"</span>, <span class="st">"longitude_deg"</span>, <span class="st">"type"</span>)]</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>data20 <span class="ot">&lt;-</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">find_clust_diff</span>(</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    net2019_clust <span class="sc">%&gt;%</span> <span class="fu">filter</span>(name <span class="sc">%in%</span> airports19),</span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    net2020_clust <span class="sc">%&gt;%</span> <span class="fu">filter</span>(name <span class="sc">%in%</span> airports20),</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"airport"</span>,</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(node.coords, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span> <span class="ot">=</span> <span class="st">"ident"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(name, week)`
Joining with `by = join_by(name, week)`
Joining with `by = join_by(name, clust)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>data21 <span class="ot">&lt;-</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">find_clust_diff</span>(</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    net2019_clust <span class="sc">%&gt;%</span> <span class="fu">filter</span>(name <span class="sc">%in%</span> airports19),</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    net2021_clust <span class="sc">%&gt;%</span> <span class="fu">filter</span>(name <span class="sc">%in%</span> airports21),</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"airport"</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(node.coords, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span> <span class="ot">=</span> <span class="st">"ident"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(name, week)`
Joining with `by = join_by(name, week)`
Joining with `by = join_by(name, clust)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>data22 <span class="ot">&lt;-</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">find_clust_diff</span>(</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    net2019_clust <span class="sc">%&gt;%</span> <span class="fu">filter</span>(name <span class="sc">%in%</span> airports19),</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    net2022_clust <span class="sc">%&gt;%</span> <span class="fu">filter</span>(name <span class="sc">%in%</span> airports22),</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"airport"</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(node.coords, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"name"</span> <span class="ot">=</span> <span class="st">"ident"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(name, week)`
Joining with `by = join_by(name, week)`
Joining with `by = join_by(name, clust)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>data_full <span class="ot">&lt;-</span> <span class="fu">rbind</span>(<span class="fu">cbind</span>(data20, <span class="at">year =</span> <span class="dv">2020</span>),</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">cbind</span>(data21, <span class="at">year =</span> <span class="dv">2021</span>),</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">cbind</span>(data22, <span class="at">year =</span> <span class="dv">2022</span>))</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>plot_region <span class="ot">&lt;-</span> <span class="cf">function</span>(region, country_name, data, <span class="at">years =</span> <span class="dv">2020</span><span class="sc">:</span><span class="dv">2022</span>) {</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>  colour_breaks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">3</span>, <span class="sc">-</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span>.<span class="dv">5</span>, <span class="dv">0</span>, .<span class="dv">5</span>, <span class="dv">1</span>)</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>  colours <span class="ot">&lt;-</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"red4"</span>,</span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>      <span class="st">"red3"</span>,</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">"red2"</span>,</span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>      <span class="st">"tomato3"</span>,</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>      <span class="st">"white"</span>,</span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a>      <span class="st">"dodgerblue2"</span>,</span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a>      <span class="st">"dodgerblue4"</span>)</span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">ne_countries</span>(</span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">country =</span> country_name,</span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">returnclass =</span> <span class="st">"sf"</span>,</span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="st">"large"</span></span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_sf</span>(<span class="at">fill =</span> <span class="st">"grey99"</span>) <span class="sc">+</span></span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_jitter</span>(</span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">aes</span>(</span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> latitude_deg,</span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> longitude_deg,</span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill =</span> diff,</span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">shape =</span> <span class="fu">factor</span>(<span class="fu">ifelse</span>(</span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true" tabindex="-1"></a>          <span class="fu">round</span>(avg_role_base) <span class="sc">&lt;=</span> <span class="dv">2</span>,</span>
<span id="cb74-30"><a href="#cb74-30" aria-hidden="true" tabindex="-1"></a>          <span class="st">"&lt;=2"</span>, <span class="fu">as.character</span>(<span class="fu">round</span>(avg_role_base))</span>
<span id="cb74-31"><a href="#cb74-31" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb74-32"><a href="#cb74-32" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb74-33"><a href="#cb74-33" aria-hidden="true" tabindex="-1"></a>      data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">substr</span>(name, <span class="dv">1</span>, <span class="dv">2</span>) <span class="sc">==</span> region) <span class="sc">%&gt;%</span> <span class="fu">filter</span>(year <span class="sc">%in%</span> years),</span>
<span id="cb74-34"><a href="#cb74-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">size =</span> <span class="fl">2.5</span>,</span>
<span id="cb74-35"><a href="#cb74-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">alpha =</span> .<span class="dv">9</span></span>
<span id="cb74-36"><a href="#cb74-36" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb74-37"><a href="#cb74-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_shape_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="dv">21</span>, <span class="dv">22</span>, <span class="dv">23</span>, <span class="dv">24</span>, <span class="dv">25</span>)) <span class="sc">+</span></span>
<span id="cb74-38"><a href="#cb74-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_gradientn</span>(</span>
<span id="cb74-39"><a href="#cb74-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">limits  =</span> <span class="fu">range</span>(data[<span class="fu">substr</span>(data<span class="sc">$</span>name, <span class="dv">1</span>, <span class="dv">2</span>) <span class="sc">==</span> region, ]<span class="sc">$</span>diff),</span>
<span id="cb74-40"><a href="#cb74-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">colours =</span> colours[<span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">seq_along</span>(colours), <span class="fu">length</span>(colours))],</span>
<span id="cb74-41"><a href="#cb74-41" aria-hidden="true" tabindex="-1"></a>      <span class="at">values  =</span> <span class="fu">c</span>(<span class="dv">0</span>, scales<span class="sc">::</span><span class="fu">rescale</span>(colour_breaks,</span>
<span id="cb74-42"><a href="#cb74-42" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">from =</span> <span class="fu">range</span>(data[<span class="fu">substr</span>(data<span class="sc">$</span>name, <span class="dv">1</span>, <span class="dv">2</span>) <span class="sc">==</span> region, ]<span class="sc">$</span>diff)), <span class="dv">1</span>),</span>
<span id="cb74-43"><a href="#cb74-43" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb74-44"><a href="#cb74-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb74-45"><a href="#cb74-45" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">panel.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"aliceblue"</span>)) <span class="sc">+</span></span>
<span id="cb74-46"><a href="#cb74-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">shape =</span> <span class="st">""</span>) <span class="sc">+</span></span>
<span id="cb74-47"><a href="#cb74-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>( <span class="sc">~</span> year)</span>
<span id="cb74-48"><a href="#cb74-48" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-warnings="false">
<div class="cell-output-display">
<p><img src="sample-code-for-repo-quarto_files/figure-html/regional-plots-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in regularize.values(x, y, ties, missing(ties), na.rm = na.rm):
collapsing to unique 'x' values

Warning in regularize.values(x, y, ties, missing(ties), na.rm = na.rm):
collapsing to unique 'x' values

Warning in regularize.values(x, y, ties, missing(ties), na.rm = na.rm):
collapsing to unique 'x' values</code></pre>
</div>
<div class="cell-output-display">
<p><img src="sample-code-for-repo-quarto_files/figure-html/regional-plots-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in regularize.values(x, y, ties, missing(ties), na.rm = na.rm):
collapsing to unique 'x' values

Warning in regularize.values(x, y, ties, missing(ties), na.rm = na.rm):
collapsing to unique 'x' values

Warning in regularize.values(x, y, ties, missing(ties), na.rm = na.rm):
collapsing to unique 'x' values</code></pre>
</div>
<div class="cell-output-display">
<p><img src="sample-code-for-repo-quarto_files/figure-html/regional-plots-3.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="step-5-studying-cluster-performance" class="level3">
<h3 class="anchored" data-anchor-id="step-5-studying-cluster-performance">Step 5: Studying cluster performance</h3>
<p>To study cluster performance we first need to compute the individual coverage of the N-Hop neighborhood of each airport for each week in our baseline and target years.</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>neighborhod_indices_airport <span class="ot">&lt;-</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(nodes, net, full, full_ms, <span class="at">hop =</span> <span class="dv">1</span>) {</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    create_subgraph <span class="ot">&lt;-</span> <span class="cf">function</span>(el, nodes, hop) {</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>      subset_el <span class="ot">&lt;-</span> <span class="cf">function</span>(el, nodes) {</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>        sub_el <span class="ot">&lt;-</span> el <span class="sc">%&gt;%</span> <span class="fu">filter</span>(from <span class="sc">%in%</span> nodes <span class="sc">|</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>                                  to <span class="sc">%in%</span> nodes)</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>        rest <span class="ot">&lt;-</span> el <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>from <span class="sc">%in%</span> nodes <span class="sc">&amp;</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>                                <span class="sc">!</span>to <span class="sc">%in%</span> nodes)</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">list</span>(sub_el,</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>                    rest))</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">sum</span>(<span class="fu">names</span>(el) <span class="sc">%in%</span> <span class="st">"n"</span>) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>        el <span class="ot">&lt;-</span> el <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">weight =</span> n)</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">sum</span>(<span class="fu">names</span>(el) <span class="sc">%in%</span> <span class="st">"origin"</span>) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a>        el <span class="ot">&lt;-</span> el <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">from =</span> origin,</span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a>                            <span class="at">to =</span> destination)</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>      net <span class="ot">&lt;-</span> el</span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (hop <span class="sc">&gt;=</span> <span class="dv">1</span>) {</span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>        hop_1 <span class="ot">&lt;-</span> <span class="fu">subset_el</span>(net, nodes)</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (hop <span class="sc">&gt;=</span> <span class="dv">2</span>) {</span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>        hop_1_nodes <span class="ot">&lt;-</span> <span class="fu">c</span>(hop_1[[<span class="dv">1</span>]]<span class="sc">$</span>to, hop_1[[<span class="dv">1</span>]]<span class="sc">$</span>from) <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>        hop_1_nodes <span class="ot">&lt;-</span></span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>          hop_1_nodes[<span class="sc">!</span>hop_1_nodes <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"ZZZZ"</span>, <span class="st">"AFIL"</span>)]</span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>        hop_2 <span class="ot">&lt;-</span> <span class="fu">subset_el</span>(hop_1[[<span class="dv">2</span>]], hop_1_nodes)</span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (hop <span class="sc">==</span> <span class="dv">3</span>) {</span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>        hop_2_nodes <span class="ot">&lt;-</span> <span class="fu">c</span>(hop_2[[<span class="dv">1</span>]]<span class="sc">$</span>to, hop_2[[<span class="dv">1</span>]]<span class="sc">$</span>from) <span class="sc">%&gt;%</span> <span class="fu">unique</span>()</span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>        hop_2_nodes <span class="ot">&lt;-</span></span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>          hop_2_nodes[<span class="sc">!</span>hop_2_nodes <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"ZZZZ"</span>, <span class="st">"AFIL"</span>)]</span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>        hop_3 <span class="ot">&lt;-</span> <span class="fu">subset_el</span>(hop_2[[<span class="dv">2</span>]], hop_2_nodes)</span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (hop <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(hop_1[[<span class="dv">1</span>]])</span>
<span id="cb77-37"><a href="#cb77-37" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> <span class="cf">if</span> (hop <span class="sc">==</span> <span class="dv">2</span>) {</span>
<span id="cb77-38"><a href="#cb77-38" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">rbind</span>(hop_1[[<span class="dv">1</span>]], hop_2[[<span class="dv">1</span>]]))</span>
<span id="cb77-39"><a href="#cb77-39" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb77-40"><a href="#cb77-40" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">rbind</span>(hop_1[[<span class="dv">1</span>]], hop_2[[<span class="dv">1</span>]], hop_3[[<span class="dv">1</span>]]))</span>
<span id="cb77-41"><a href="#cb77-41" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb77-42"><a href="#cb77-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb77-43"><a href="#cb77-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">sum</span>(<span class="fu">names</span>(net) <span class="sc">%in%</span> <span class="st">"n"</span>) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb77-44"><a href="#cb77-44" aria-hidden="true" tabindex="-1"></a>      net <span class="ot">&lt;-</span> net <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">weight =</span> n)</span>
<span id="cb77-45"><a href="#cb77-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb77-46"><a href="#cb77-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">sum</span>(<span class="fu">names</span>(net) <span class="sc">%in%</span> <span class="st">"origin"</span>) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb77-47"><a href="#cb77-47" aria-hidden="true" tabindex="-1"></a>      net <span class="ot">&lt;-</span> net <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">from =</span> origin,</span>
<span id="cb77-48"><a href="#cb77-48" aria-hidden="true" tabindex="-1"></a>                            <span class="at">to =</span> destination)</span>
<span id="cb77-49"><a href="#cb77-49" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb77-50"><a href="#cb77-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-51"><a href="#cb77-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># "Scheduled" is no longer used from 2019 onward. Data contained handfull of instances of Scheduled</span></span>
<span id="cb77-52"><a href="#cb77-52" aria-hidden="true" tabindex="-1"></a>    net <span class="ot">&lt;-</span> net <span class="sc">%&gt;%</span> <span class="fu">filter</span>(market_segment <span class="sc">!=</span> <span class="st">"Scheduled"</span>)</span>
<span id="cb77-53"><a href="#cb77-53" aria-hidden="true" tabindex="-1"></a>    nb <span class="ot">&lt;-</span> <span class="fu">create_subgraph</span>(net, nodes, hop)</span>
<span id="cb77-54"><a href="#cb77-54" aria-hidden="true" tabindex="-1"></a>    sub <span class="ot">&lt;-</span> nb <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(week) <span class="sc">%&gt;%</span></span>
<span id="cb77-55"><a href="#cb77-55" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(</span>
<span id="cb77-56"><a href="#cb77-56" aria-hidden="true" tabindex="-1"></a>        <span class="at">v =</span> <span class="fu">c</span>(from, to) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>(),</span>
<span id="cb77-57"><a href="#cb77-57" aria-hidden="true" tabindex="-1"></a>        <span class="at">e =</span> <span class="fu">paste</span>(from, to) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>(),</span>
<span id="cb77-58"><a href="#cb77-58" aria-hidden="true" tabindex="-1"></a>        <span class="at">w =</span> <span class="fu">sum</span>(weight),</span>
<span id="cb77-59"><a href="#cb77-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">avg_weights =</span> <span class="fu">round</span>(w <span class="sc">/</span> e, <span class="dv">2</span>)</span>
<span id="cb77-60"><a href="#cb77-60" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb77-61"><a href="#cb77-61" aria-hidden="true" tabindex="-1"></a>    sub <span class="ot">&lt;-</span> <span class="fu">left_join</span>(sub, full)</span>
<span id="cb77-62"><a href="#cb77-62" aria-hidden="true" tabindex="-1"></a>    sub <span class="ot">&lt;-</span> sub <span class="sc">%&gt;%</span></span>
<span id="cb77-63"><a href="#cb77-63" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb77-64"><a href="#cb77-64" aria-hidden="true" tabindex="-1"></a>        <span class="at">perc_edges =</span> <span class="fu">round</span>(e <span class="sc">/</span> e_full, <span class="dv">4</span>),</span>
<span id="cb77-65"><a href="#cb77-65" aria-hidden="true" tabindex="-1"></a>        <span class="at">perc_vertices =</span> <span class="fu">round</span>(v <span class="sc">/</span> v_full, <span class="dv">4</span>),</span>
<span id="cb77-66"><a href="#cb77-66" aria-hidden="true" tabindex="-1"></a>        <span class="at">perc_weights =</span> <span class="fu">round</span>(w <span class="sc">/</span> w_full, <span class="dv">4</span>)</span>
<span id="cb77-67"><a href="#cb77-67" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb77-68"><a href="#cb77-68" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(week,</span>
<span id="cb77-69"><a href="#cb77-69" aria-hidden="true" tabindex="-1"></a>             v,</span>
<span id="cb77-70"><a href="#cb77-70" aria-hidden="true" tabindex="-1"></a>             e,</span>
<span id="cb77-71"><a href="#cb77-71" aria-hidden="true" tabindex="-1"></a>             w,</span>
<span id="cb77-72"><a href="#cb77-72" aria-hidden="true" tabindex="-1"></a>             avg_weights,</span>
<span id="cb77-73"><a href="#cb77-73" aria-hidden="true" tabindex="-1"></a>             perc_edges,</span>
<span id="cb77-74"><a href="#cb77-74" aria-hidden="true" tabindex="-1"></a>             perc_vertices,</span>
<span id="cb77-75"><a href="#cb77-75" aria-hidden="true" tabindex="-1"></a>             perc_weights)</span>
<span id="cb77-76"><a href="#cb77-76" aria-hidden="true" tabindex="-1"></a>    sub<span class="sc">$</span>market_segment <span class="ot">&lt;-</span> <span class="st">"All-flights"</span></span>
<span id="cb77-77"><a href="#cb77-77" aria-hidden="true" tabindex="-1"></a>    sub_ms <span class="ot">&lt;-</span> nb <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(week, market_segment) <span class="sc">%&gt;%</span></span>
<span id="cb77-78"><a href="#cb77-78" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(</span>
<span id="cb77-79"><a href="#cb77-79" aria-hidden="true" tabindex="-1"></a>        <span class="at">v =</span> <span class="fu">c</span>(from, to) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>(),</span>
<span id="cb77-80"><a href="#cb77-80" aria-hidden="true" tabindex="-1"></a>        <span class="at">e =</span> <span class="fu">paste</span>(from, to) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>(),</span>
<span id="cb77-81"><a href="#cb77-81" aria-hidden="true" tabindex="-1"></a>        <span class="at">w =</span> <span class="fu">sum</span>(weight),</span>
<span id="cb77-82"><a href="#cb77-82" aria-hidden="true" tabindex="-1"></a>        <span class="at">avg_weights =</span> <span class="fu">round</span>(w <span class="sc">/</span> e, <span class="dv">2</span>)</span>
<span id="cb77-83"><a href="#cb77-83" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb77-84"><a href="#cb77-84" aria-hidden="true" tabindex="-1"></a>    sub_ms <span class="ot">&lt;-</span></span>
<span id="cb77-85"><a href="#cb77-85" aria-hidden="true" tabindex="-1"></a>      <span class="fu">left_join</span>(sub_ms, full_ms, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"week"</span>, <span class="st">"market_segment"</span>))</span>
<span id="cb77-86"><a href="#cb77-86" aria-hidden="true" tabindex="-1"></a>    sub_ms <span class="ot">&lt;-</span> sub_ms <span class="sc">%&gt;%</span></span>
<span id="cb77-87"><a href="#cb77-87" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(</span>
<span id="cb77-88"><a href="#cb77-88" aria-hidden="true" tabindex="-1"></a>        <span class="at">perc_edges =</span> <span class="fu">round</span>(e <span class="sc">/</span> e_full, <span class="dv">4</span>),</span>
<span id="cb77-89"><a href="#cb77-89" aria-hidden="true" tabindex="-1"></a>        <span class="at">perc_vertices =</span> <span class="fu">round</span>(v <span class="sc">/</span> v_full, <span class="dv">4</span>),</span>
<span id="cb77-90"><a href="#cb77-90" aria-hidden="true" tabindex="-1"></a>        <span class="at">perc_weights =</span> <span class="fu">round</span>(w <span class="sc">/</span> w_full, <span class="dv">4</span>)</span>
<span id="cb77-91"><a href="#cb77-91" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb77-92"><a href="#cb77-92" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(week,</span>
<span id="cb77-93"><a href="#cb77-93" aria-hidden="true" tabindex="-1"></a>             market_segment,</span>
<span id="cb77-94"><a href="#cb77-94" aria-hidden="true" tabindex="-1"></a>             v,</span>
<span id="cb77-95"><a href="#cb77-95" aria-hidden="true" tabindex="-1"></a>             e,</span>
<span id="cb77-96"><a href="#cb77-96" aria-hidden="true" tabindex="-1"></a>             w,</span>
<span id="cb77-97"><a href="#cb77-97" aria-hidden="true" tabindex="-1"></a>             avg_weights,</span>
<span id="cb77-98"><a href="#cb77-98" aria-hidden="true" tabindex="-1"></a>             perc_edges,</span>
<span id="cb77-99"><a href="#cb77-99" aria-hidden="true" tabindex="-1"></a>             perc_vertices,</span>
<span id="cb77-100"><a href="#cb77-100" aria-hidden="true" tabindex="-1"></a>             perc_weights)</span>
<span id="cb77-101"><a href="#cb77-101" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> <span class="fu">rbind</span>(sub, sub_ms)</span>
<span id="cb77-102"><a href="#cb77-102" aria-hidden="true" tabindex="-1"></a>    result<span class="sc">$</span>name <span class="ot">=</span> nodes</span>
<span id="cb77-103"><a href="#cb77-103" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(result)</span>
<span id="cb77-104"><a href="#cb77-104" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb77-105"><a href="#cb77-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-106"><a href="#cb77-106" aria-hidden="true" tabindex="-1"></a>full <span class="ot">&lt;-</span> net2019 <span class="sc">%&gt;%</span></span>
<span id="cb77-107"><a href="#cb77-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">from =</span> origin,</span>
<span id="cb77-108"><a href="#cb77-108" aria-hidden="true" tabindex="-1"></a>         <span class="at">to =</span> destination) <span class="sc">%&gt;%</span></span>
<span id="cb77-109"><a href="#cb77-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(week) <span class="sc">%&gt;%</span></span>
<span id="cb77-110"><a href="#cb77-110" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb77-111"><a href="#cb77-111" aria-hidden="true" tabindex="-1"></a>    <span class="at">v_full =</span> <span class="fu">c</span>(from, to) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>(),</span>
<span id="cb77-112"><a href="#cb77-112" aria-hidden="true" tabindex="-1"></a>    <span class="at">e_full =</span> <span class="fu">paste</span>(from, to) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>(),</span>
<span id="cb77-113"><a href="#cb77-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">w_full =</span> <span class="fu">sum</span>(weight)</span>
<span id="cb77-114"><a href="#cb77-114" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb77-115"><a href="#cb77-115" aria-hidden="true" tabindex="-1"></a>full_ms <span class="ot">&lt;-</span> net2019 <span class="sc">%&gt;%</span></span>
<span id="cb77-116"><a href="#cb77-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">from =</span> origin,</span>
<span id="cb77-117"><a href="#cb77-117" aria-hidden="true" tabindex="-1"></a>         <span class="at">to =</span> destination) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(week, market_segment) <span class="sc">%&gt;%</span></span>
<span id="cb77-118"><a href="#cb77-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb77-119"><a href="#cb77-119" aria-hidden="true" tabindex="-1"></a>    <span class="at">v_full =</span> <span class="fu">c</span>(from, to) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>(),</span>
<span id="cb77-120"><a href="#cb77-120" aria-hidden="true" tabindex="-1"></a>    <span class="at">e_full =</span> <span class="fu">paste</span>(from, to) <span class="sc">%&gt;%</span> <span class="fu">unique</span>() <span class="sc">%&gt;%</span> <span class="fu">length</span>(),</span>
<span id="cb77-121"><a href="#cb77-121" aria-hidden="true" tabindex="-1"></a>    <span class="at">w_full =</span> <span class="fu">sum</span>(weight)</span>
<span id="cb77-122"><a href="#cb77-122" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'week'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rbind</span>(</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">neighborhod_indices_airport</span>(<span class="st">"EHAM"</span>, net2019, full, full_ms, <span class="at">hop =</span> <span class="dv">1</span>)<span class="sc">%&gt;%</span><span class="fu">mutate</span>(<span class="at">hop=</span><span class="dv">1</span>),</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">neighborhod_indices_airport</span>(<span class="st">"EHAM"</span>, net2019, full, full_ms, <span class="at">hop =</span> <span class="dv">2</span>)<span class="sc">%&gt;%</span><span class="fu">mutate</span>(<span class="at">hop=</span><span class="dv">2</span>),</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">neighborhod_indices_airport</span>(<span class="st">"EHAM"</span>, net2019, full, full_ms, <span class="at">hop =</span> <span class="dv">3</span>)<span class="sc">%&gt;%</span><span class="fu">mutate</span>(<span class="at">hop=</span><span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(week)`
`summarise()` has grouped output by 'week'. You can override using the
`.groups` argument.
Joining with `by = join_by(week)`
`summarise()` has grouped output by 'week'. You can override using the
`.groups` argument.
Joining with `by = join_by(week)`
`summarise()` has grouped output by 'week'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 162 x 11
    week     v     e     w avg_weights perc_edges perc_vertices perc_weights
   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;       &lt;dbl&gt;      &lt;dbl&gt;         &lt;dbl&gt;        &lt;dbl&gt;
 1    26   364   649 10408       16.0      0.0172         0.185       0.0433
 2    27   361   648 10436       16.1      0.0175         0.185       0.0435
 3    28   374   660 10476       15.9      0.0178         0.190       0.0437
 4    29   360   645 10483       16.2      0.0176         0.184       0.044 
 5    30   342   617  9946       16.1      0.0169         0.177       0.0421
 6    31   344   624 10385       16.6      0.0174         0.176       0.044 
 7    26   128   171   290        1.7      0.0147         0.112       0.0162
 8    26    54    74   264        3.57     0.0381         0.129       0.0368
 9    26   152   281  2507        8.92     0.0218         0.274       0.0319
10    26   157   299  4635       15.5      0.0351         0.230       0.0557
# i 152 more rows
# i 3 more variables: market_segment &lt;chr&gt;, name &lt;chr&gt;, hop &lt;dbl&gt;</code></pre>
</div>
</div>
<p>This is a computationally intensive process, as for instance the 2019 network contains 870 airports of interest. For the sake of brevity, we include a pre-computed dataset for each of the weeks including in this sample which we join together with the airport classifications.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co">#|label: load-sample-nb</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="co">#|include: true</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>net2019_nb_airport <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"sample_2019_nb.csv"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(net2019_clust) <span class="sc">%&gt;%</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(clust))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(week, name, year)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>net2020_nb_airport <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"sample_2020_nb.csv"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(net2020_clust) <span class="sc">%&gt;%</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(clust))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(week, name, year)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>net2021_nb_airport <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"sample_2021_nb.csv"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(net2021_clust) <span class="sc">%&gt;%</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(clust))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(week, name, year)`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>net2022_nb_airport <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">"sample_2022_nb.csv"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(net2022_clust) <span class="sc">%&gt;%</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(clust))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(week, name, year)`</code></pre>
</div>
</div>
<p>The basis for the analysis is the partially overlapping samples t-test. This test allows us to specify which cases of the samples that we want to compare exist in both samples (i.e., an airport that was in cluster 6 that is still in cluster 6) and which cases do not exist in both samples (i.e., an airport that was in cluster 6 that dropped to cluster 5 or vice versa).</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>compare_overlapped_distributions <span class="ot">&lt;-</span> <span class="cf">function</span>(base, new, outcome) {</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  sample1 <span class="ot">&lt;-</span> new <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">paste</span>(name, week))</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>  sample2 <span class="ot">&lt;-</span> base <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">paste</span>(name, week))</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>  unpaired.s1 <span class="ot">&lt;-</span> sample1 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>name <span class="sc">%in%</span> sample2<span class="sc">$</span>name)</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>  unpaired.s2 <span class="ot">&lt;-</span> sample2 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span>name <span class="sc">%in%</span> sample1<span class="sc">$</span>name)</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>  paired.s1 <span class="ot">&lt;-</span> sample1 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(name <span class="sc">%in%</span> sample2<span class="sc">$</span>name)</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>  paired.s2 <span class="ot">&lt;-</span> sample2 <span class="sc">%&gt;%</span> <span class="fu">filter</span>(name <span class="sc">%in%</span> sample1<span class="sc">$</span>name)</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Partover.test</span>(</span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">x1 =</span> unpaired.s1 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">all_of</span>(outcome)) <span class="sc">%&gt;%</span> <span class="fu">unlist</span>(),</span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">x2 =</span> unpaired.s2 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">all_of</span>(outcome)) <span class="sc">%&gt;%</span> <span class="fu">unlist</span>(),</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">x3 =</span> paired.s1 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">all_of</span>(outcome)) <span class="sc">%&gt;%</span> <span class="fu">unlist</span>(),</span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">x4 =</span> paired.s2 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">all_of</span>(outcome)) <span class="sc">%&gt;%</span> <span class="fu">unlist</span>(),</span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">conf.level =</span> .<span class="dv">95</span></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.frame</span>(</span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_new =</span> sample1 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">all_of</span>(outcome)) <span class="sc">%&gt;%</span> <span class="fu">unlist</span>() <span class="sc">%&gt;%</span> <span class="fu">mean</span>(),</span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean_base =</span> sample2 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">all_of</span>(outcome)) <span class="sc">%&gt;%</span> <span class="fu">unlist</span>() <span class="sc">%&gt;%</span></span>
<span id="cb90-25"><a href="#cb90-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mean</span>(),</span>
<span id="cb90-26"><a href="#cb90-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">estimate =</span> res<span class="sc">$</span>estimate,</span>
<span id="cb90-27"><a href="#cb90-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">statistic =</span> res<span class="sc">$</span>statistic,</span>
<span id="cb90-28"><a href="#cb90-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">df =</span> res<span class="sc">$</span>parameter,</span>
<span id="cb90-29"><a href="#cb90-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">p.value =</span> res<span class="sc">$</span>p.value,</span>
<span id="cb90-30"><a href="#cb90-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">conf.ll =</span> res<span class="sc">$</span>conf.int[<span class="dv">1</span>],</span>
<span id="cb90-31"><a href="#cb90-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">conf.ul =</span> res<span class="sc">$</span>conf.int[<span class="dv">2</span>]</span>
<span id="cb90-32"><a href="#cb90-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb90-33"><a href="#cb90-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb90-34"><a href="#cb90-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-35"><a href="#cb90-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following code applies the test to each combination of cluster, hop, and week. Note that in the paper we look at a monthly level, rather than a weekly level.</p>
<div class="cell" data-warnings="false">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>create_ttest_table <span class="ot">&lt;-</span> <span class="cf">function</span>(base, new, outcome, weeks) {</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (outcome <span class="sc">%&gt;%</span> <span class="fu">length</span>() <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>    tab <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">out =</span> outcome, <span class="at">.combine =</span> rbind) <span class="sc">%do%</span> {</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>      tab1 <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">h =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">.combine =</span> rbind) <span class="sc">%:%</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">foreach</span>(<span class="at">ci =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(base<span class="sc">$</span>clust), <span class="at">.combine =</span> rbind) <span class="sc">%:%</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">foreach</span>(<span class="at">i =</span> weeks, <span class="at">.combine =</span> rbind) <span class="sc">%do%</span> {</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>          res <span class="ot">&lt;-</span> <span class="fu">compare_overlapped_distributions</span>(</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>            base <span class="sc">%&gt;%</span> <span class="fu">filter</span>(clust <span class="sc">%in%</span> ci <span class="sc">&amp;</span> hop <span class="sc">==</span> h <span class="sc">&amp;</span> week <span class="sc">==</span> i),</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>            new <span class="sc">%&gt;%</span> <span class="fu">filter</span>(clust <span class="sc">%in%</span> ci <span class="sc">&amp;</span> hop <span class="sc">==</span> h <span class="sc">&amp;</span> week <span class="sc">==</span> i),</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>            out</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>          res <span class="ot">&lt;-</span> <span class="fu">cbind</span>(</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">week =</span> i,</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">cluster =</span> ci,</span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">hop =</span> h,</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>            <span class="fu">round</span>(res, <span class="dv">4</span>)</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>          res</span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">cbind</span>(<span class="at">outcome =</span> out, tab1)</span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a>    tab <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">h =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">.combine =</span> rbind) <span class="sc">%:%</span></span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">foreach</span>(<span class="at">ci =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(base<span class="sc">$</span>clust), <span class="at">.combine =</span> rbind) <span class="sc">%:%</span></span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">foreach</span>(<span class="at">i =</span> weeks, <span class="at">.combine =</span> rbind) <span class="sc">%do%</span> {</span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true" tabindex="-1"></a>        res <span class="ot">&lt;-</span> <span class="fu">compare_overlapped_distributions</span>(</span>
<span id="cb91-28"><a href="#cb91-28" aria-hidden="true" tabindex="-1"></a>          base <span class="sc">%&gt;%</span> <span class="fu">filter</span>(clust <span class="sc">%in%</span> ci <span class="sc">&amp;</span> hop <span class="sc">==</span> h <span class="sc">&amp;</span> week <span class="sc">==</span> i),</span>
<span id="cb91-29"><a href="#cb91-29" aria-hidden="true" tabindex="-1"></a>          new <span class="sc">%&gt;%</span> <span class="fu">filter</span>(clust <span class="sc">%in%</span> ci <span class="sc">&amp;</span> hop <span class="sc">==</span> h <span class="sc">&amp;</span> week <span class="sc">==</span> i),</span>
<span id="cb91-30"><a href="#cb91-30" aria-hidden="true" tabindex="-1"></a>          outcome</span>
<span id="cb91-31"><a href="#cb91-31" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb91-32"><a href="#cb91-32" aria-hidden="true" tabindex="-1"></a>        res <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">week =</span> i,</span>
<span id="cb91-33"><a href="#cb91-33" aria-hidden="true" tabindex="-1"></a>                     <span class="at">cluster =</span> ci,</span>
<span id="cb91-34"><a href="#cb91-34" aria-hidden="true" tabindex="-1"></a>                     <span class="at">hop =</span> h,</span>
<span id="cb91-35"><a href="#cb91-35" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">round</span>(res, <span class="dv">4</span>))</span>
<span id="cb91-36"><a href="#cb91-36" aria-hidden="true" tabindex="-1"></a>        res</span>
<span id="cb91-37"><a href="#cb91-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb91-38"><a href="#cb91-38" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb91-39"><a href="#cb91-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb91-40"><a href="#cb91-40" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb91-41"><a href="#cb91-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-42"><a href="#cb91-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(tab)</span>
<span id="cb91-43"><a href="#cb91-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb91-44"><a href="#cb91-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb91-45"><a href="#cb91-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-46"><a href="#cb91-46" aria-hidden="true" tabindex="-1"></a>ttest_19_20 <span class="ot">&lt;-</span> <span class="fu">create_ttest_table</span>(</span>
<span id="cb91-47"><a href="#cb91-47" aria-hidden="true" tabindex="-1"></a>  net2019_nb_airport <span class="sc">%&gt;%</span></span>
<span id="cb91-48"><a href="#cb91-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(name <span class="sc">%in%</span> airports19 <span class="sc">&amp;</span></span>
<span id="cb91-49"><a href="#cb91-49" aria-hidden="true" tabindex="-1"></a>             market_segment <span class="sc">==</span> <span class="st">"All-flights"</span>),</span>
<span id="cb91-50"><a href="#cb91-50" aria-hidden="true" tabindex="-1"></a>  net2020_nb_airport <span class="sc">%&gt;%</span></span>
<span id="cb91-51"><a href="#cb91-51" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(name <span class="sc">%in%</span> airports20 <span class="sc">&amp;</span></span>
<span id="cb91-52"><a href="#cb91-52" aria-hidden="true" tabindex="-1"></a>             market_segment <span class="sc">==</span> <span class="st">"All-flights"</span>),</span>
<span id="cb91-53"><a href="#cb91-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"perc_vertices"</span>, <span class="st">"perc_edges"</span>, <span class="st">"perc_weights"</span>),</span>
<span id="cb91-54"><a href="#cb91-54" aria-hidden="true" tabindex="-1"></a>  weeks</span>
<span id="cb91-55"><a href="#cb91-55" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-56"><a href="#cb91-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-57"><a href="#cb91-57" aria-hidden="true" tabindex="-1"></a>ttest_19_21 <span class="ot">&lt;-</span> <span class="fu">create_ttest_table</span>(</span>
<span id="cb91-58"><a href="#cb91-58" aria-hidden="true" tabindex="-1"></a>  net2019_nb_airport <span class="sc">%&gt;%</span></span>
<span id="cb91-59"><a href="#cb91-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(name <span class="sc">%in%</span> airports19 <span class="sc">&amp;</span></span>
<span id="cb91-60"><a href="#cb91-60" aria-hidden="true" tabindex="-1"></a>             market_segment <span class="sc">==</span> <span class="st">"All-flights"</span>),</span>
<span id="cb91-61"><a href="#cb91-61" aria-hidden="true" tabindex="-1"></a>  net2021_nb_airport <span class="sc">%&gt;%</span></span>
<span id="cb91-62"><a href="#cb91-62" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(name <span class="sc">%in%</span> airports21 <span class="sc">&amp;</span></span>
<span id="cb91-63"><a href="#cb91-63" aria-hidden="true" tabindex="-1"></a>             market_segment <span class="sc">==</span> <span class="st">"All-flights"</span>),</span>
<span id="cb91-64"><a href="#cb91-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"perc_vertices"</span>, <span class="st">"perc_edges"</span>, <span class="st">"perc_weights"</span>),</span>
<span id="cb91-65"><a href="#cb91-65" aria-hidden="true" tabindex="-1"></a>  weeks</span>
<span id="cb91-66"><a href="#cb91-66" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb91-67"><a href="#cb91-67" aria-hidden="true" tabindex="-1"></a>ttest_19_22 <span class="ot">&lt;-</span> <span class="fu">create_ttest_table</span>(</span>
<span id="cb91-68"><a href="#cb91-68" aria-hidden="true" tabindex="-1"></a>  net2019_nb_airport <span class="sc">%&gt;%</span></span>
<span id="cb91-69"><a href="#cb91-69" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(name <span class="sc">%in%</span> airports19 <span class="sc">&amp;</span></span>
<span id="cb91-70"><a href="#cb91-70" aria-hidden="true" tabindex="-1"></a>             market_segment <span class="sc">==</span> <span class="st">"All-flights"</span>),</span>
<span id="cb91-71"><a href="#cb91-71" aria-hidden="true" tabindex="-1"></a>  net2022_nb_airport <span class="sc">%&gt;%</span></span>
<span id="cb91-72"><a href="#cb91-72" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(name <span class="sc">%in%</span> airports22 <span class="sc">&amp;</span></span>
<span id="cb91-73"><a href="#cb91-73" aria-hidden="true" tabindex="-1"></a>             market_segment <span class="sc">==</span> <span class="st">"All-flights"</span>),</span>
<span id="cb91-74"><a href="#cb91-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"perc_vertices"</span>, <span class="st">"perc_edges"</span>, <span class="st">"perc_weights"</span>),</span>
<span id="cb91-75"><a href="#cb91-75" aria-hidden="true" tabindex="-1"></a>  weeks</span>
<span id="cb91-76"><a href="#cb91-76" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co">#|label: performance-plots</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="co">#|echo: false</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="co">#|warnings: false</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>ttest_19_20 <span class="sc">%&gt;%</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">factor</span>(week),</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> estimate,</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> hop,</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="fu">factor</span>(hop)</span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">factor</span>(week),</span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> conf.ul,</span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> hop,</span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="fu">factor</span>(hop)</span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">5</span>,</span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">"dashed"</span></span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">factor</span>(week),</span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> conf.ll,</span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> hop,</span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="fu">factor</span>(hop)</span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb92-29"><a href="#cb92-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">5</span>,</span>
<span id="cb92-30"><a href="#cb92-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">"dashed"</span></span>
<span id="cb92-31"><a href="#cb92-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb92-32"><a href="#cb92-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb92-33"><a href="#cb92-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( <span class="sc">~</span> outcome <span class="sc">+</span> cluster, <span class="at">ncol =</span> <span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb92-34"><a href="#cb92-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)<span class="sc">+</span></span>
<span id="cb92-35"><a href="#cb92-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Performance comparisson 2019 and 2020"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="sample-code-for-repo-quarto_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>ttest_19_21 <span class="sc">%&gt;%</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">factor</span>(week),</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> estimate,</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> hop,</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="fu">factor</span>(hop)</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">factor</span>(week),</span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> conf.ul,</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> hop,</span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="fu">factor</span>(hop)</span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">5</span>,</span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">"dashed"</span></span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">factor</span>(week),</span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> conf.ll,</span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> hop,</span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="fu">factor</span>(hop)</span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb93-25"><a href="#cb93-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">5</span>,</span>
<span id="cb93-26"><a href="#cb93-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">"dashed"</span></span>
<span id="cb93-27"><a href="#cb93-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb93-28"><a href="#cb93-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb93-29"><a href="#cb93-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( <span class="sc">~</span> outcome <span class="sc">+</span> cluster, <span class="at">ncol =</span> <span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb93-30"><a href="#cb93-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)<span class="sc">+</span></span>
<span id="cb93-31"><a href="#cb93-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Performance comparisson 2019 and 2021"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="sample-code-for-repo-quarto_files/figure-html/unnamed-chunk-25-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>ttest_19_22 <span class="sc">%&gt;%</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">factor</span>(week),</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> estimate,</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> hop,</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="fu">factor</span>(hop)</span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">factor</span>(week),</span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> conf.ul,</span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> hop,</span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="fu">factor</span>(hop)</span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">5</span>,</span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">"dashed"</span></span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(</span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> <span class="fu">factor</span>(week),</span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> conf.ll,</span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> hop,</span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">color =</span> <span class="fu">factor</span>(hop)</span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">5</span>,</span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">"dashed"</span></span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>( <span class="sc">~</span> outcome <span class="sc">+</span> cluster, <span class="at">ncol =</span> <span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb94-30"><a href="#cb94-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)<span class="sc">+</span></span>
<span id="cb94-31"><a href="#cb94-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Performance comparisson 2019 and 2022"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="sample-code-for-repo-quarto_files/figure-html/unnamed-chunk-25-3.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>